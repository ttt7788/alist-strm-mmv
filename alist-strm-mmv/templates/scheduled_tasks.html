{% extends "index.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0 text-dark"><i class="bi bi-clock-fill text-primary me-2"></i>定时任务列表</h2>
    <div>
        <button id="delete-selected" class="btn btn-danger rounded-pill px-4 shadow-sm me-2"><i class="bi bi-trash-fill me-1"></i> 批量删除</button>
        <a href="{{ url_for('new_task') }}" class="btn btn-primary rounded-pill px-4 shadow-sm"><i class="bi bi-plus-lg me-1"></i> 添加新任务</a>
    </div>
</div>

<div class="card shadow-sm border-0 overflow-hidden rounded-4 bg-white">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light text-secondary">
                <tr>
                    <th scope="col" class="ps-4 py-3" style="width: 40px;">
                        <input class="form-check-input" type="checkbox" id="select-all">
                    </th>
                    <th scope="col" class="py-3">任务名称</th>
                    <th scope="col" class="py-3">时间频率</th>
                    <th scope="col" class="py-3">执行模式</th>
                    <th scope="col" class="py-3">状态</th>
                    <th scope="col" class="py-3 text-end pe-4">操作管理</th>
                </tr>
            </thead>
            <tbody class="border-top-0">
            {% for task in tasks %}
                <tr>
                    <td class="ps-4">
                        <input class="form-check-input task-checkbox" type="checkbox" name="selected_tasks" value="{{ task['task_id'] }}">
                    </td>
                    <td>
                        <div class="fw-bold text-dark">{{ task['task_name'] }}</div>
                        {% if task['config_id'] %}
                            <span class="badge bg-light text-secondary border mt-1"><i class="bi bi-link me-1"></i>配置ID: {{ task['config_id'] }}</span>
                        {% endif %}
                    </td>
                    <td><span class="text-muted"><i class="bi bi-calendar3 me-1"></i>{{ task['interval_description'] }}</span></td>
                    <td>
                        {% if task['task_mode'] == 'strm_creation' %}
                            <span class="badge bg-primary bg-opacity-10 text-primary px-2 py-1"><i class="bi bi-lightning-charge-fill me-1"></i>STRM 同步</span>
                        {% elif task['task_mode'] == 'strm_validation_quick' %}
                            <span class="badge bg-warning bg-opacity-10 text-warning px-2 py-1"><i class="bi bi-search me-1"></i>检测 (快扫)</span>
                        {% elif task['task_mode'] == 'strm_validation_slow' %}
                            <span class="badge bg-info bg-opacity-10 text-info px-2 py-1"><i class="bi bi-zoom-in me-1"></i>检测 (慢扫)</span>
                        {% else %}
                            <span class="badge bg-secondary">未知模式</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if task['is_enabled'] %}
                            <span class="badge bg-success rounded-pill px-3">已启用</span>
                        {% else %}
                            <span class="badge bg-danger rounded-pill px-3">已禁用</span>
                        {% endif %}
                    </td>
                    <td class="text-end pe-4">
                        <div class="d-flex gap-2 justify-content-end text-nowrap">
                            <form action="{{ url_for('run_task_now', task_id=task['task_id']) }}" method="POST" class="m-0">
                                <button type="submit" class="btn btn-sm btn-outline-success rounded-pill px-3" title="立即运行"><i class="bi bi-play-fill me-1"></i>运行</button>
                            </form>
                            <form action="{{ url_for('stop_task_route', task_id=task['task_id']) }}" method="POST" class="m-0">
                                <button type="submit" class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="return confirm('确定要停止该任务吗？');" title="停止执行"><i class="bi bi-stop-fill me-1"></i>停止</button>
                            </form>
                            <a href="{{ url_for('view_logs', task_id=task['task_id']) }}" class="btn btn-sm btn-outline-info rounded-pill px-3" title="查看日志"><i class="bi bi-file-text me-1"></i>日志</a>
                            <a href="{{ url_for('update_task', task_id=task['task_id']) }}" class="btn btn-sm btn-outline-warning rounded-pill px-3 text-dark" title="编辑任务"><i class="bi bi-pencil-square me-1"></i>编辑</a>
                            <form action="{{ url_for('delete_task', task_id=task['task_id']) }}" method="POST" class="m-0">
                                <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3" onclick="return confirm('确定要删除吗？')" title="删除任务"><i class="bi bi-trash me-1"></i>删除</button>
                            </form>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            {% if not tasks %}
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                        <i class="bi bi-calendar-x fs-1 mb-3 opacity-50 d-block"></i>暂无任何定时任务
                    </td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.getElementById('select-all').addEventListener('change', function() {
        let checkboxes = document.querySelectorAll('.task-checkbox');
        for (let checkbox of checkboxes) checkbox.checked = this.checked;
    });

    document.getElementById('delete-selected').addEventListener('click', function() {
        let selectedTasks = Array.from(document.querySelectorAll('.task-checkbox:checked')).map(cb => cb.value);
        if (selectedTasks.length === 0) return alert('请选择至少一个任务');
        
        if (confirm('确定要批量删除选中的任务吗？')) {
            fetch('{{ url_for("delete_selected_tasks") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_ids: selectedTasks })
            }).then(res => res.json()).then(data => {
                if (data.success) location.reload();
                else alert('删除任务时出错：' + data.error);
            });
        }
    });
</script>
{% endblock %}